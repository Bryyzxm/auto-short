# YouTube Cookies Setup Guide

This guide explains how to set up YouTube cookies to bypass bot detection when using yt-dlp.

## Overview

YouTube has implemented increasingly strict bot detection mechanisms that can block yt-dlp requests. Using browser cookies helps bypass these restrictions by making requests appear as if they come from a legitimate browser session.

## Environment Variable Configuration

## Environment Variable Configuration

### `YTDLP_COOKIES_CONTENT` (Recommended for Production)

Set this environment variable to contain the actual cookies content:

```bash
# .env file (recommended for development)
YTDLP_COOKIES_CONTENT="# Netscape HTTP Cookie File
# This file contains the session cookies generated by your browser
.youtube.com	TRUE	/	TRUE	1755331200	VISITOR_INFO1_LIVE	your_visitor_id_here
.youtube.com	TRUE	/	FALSE	1755331200	YSC	your_session_token_here"

# Azure App Service (via Azure Portal)
# Configuration → Application settings → Add new setting
# Name: YTDLP_COOKIES_CONTENT
# Value: [paste entire cookies file content]
```

**Advantages:**

- ✅ Works in serverless environments (Azure, Vercel)
- ✅ No file system dependencies
- ✅ Survives container restarts
- ✅ Easier deployment automation

**Considerations:**

- ⚠️ Environment variables have size limits (~32KB)
- ⚠️ Content must be properly escaped for shell/config files

### `YTDLP_COOKIES_PATH` (Alternative)

Set this environment variable to specify the path to your cookies file:

```bash
# Linux/macOS
export YTDLP_COOKIES_PATH="/path/to/your/cookies.txt"

# Windows Command Prompt
set YTDLP_COOKIES_PATH=C:\path\to\your\cookies.txt

# Windows PowerShell
$env:YTDLP_COOKIES_PATH="C:\path\to\your\cookies.txt"

# .env file (recommended for development)
YTDLP_COOKIES_PATH=/path/to/your/cookies.txt
```

**Default Path**: If not set, the system will use `backend/cookies/youtube-cookies.txt`

## How to Obtain YouTube Cookies

### Method 1: Using Browser Extension (Recommended)

1. **Install a cookies export extension:**

   - Chrome: "Get cookies.txt LOCALLY" or "cookies.txt"
   - Firefox: "cookies.txt" addon

2. **Visit YouTube:**

   - Go to https://youtube.com
   - Make sure you're logged in (optional but recommended)

3. **Export cookies:**
   - Click the extension icon
   - Select "youtube.com"
   - Choose "Netscape format"
   - Save as `youtube-cookies.txt`

### Method 2: Using yt-dlp's Built-in Cookie Extraction

```bash
# Extract cookies from Chrome
yt-dlp --cookies-from-browser chrome --write-info-json --skip-download "https://www.youtube.com/watch?v=dQw4w9WgXcQ"

# Extract cookies from Firefox
yt-dlp --cookies-from-browser firefox --write-info-json --skip-download "https://www.youtube.com/watch?v=dQw4w9WgXcQ"

# Extract cookies from Edge
yt-dlp --cookies-from-browser edge --write-info-json --skip-download "https://www.youtube.com/watch?v=dQw4w9WgXcQ"
```

### Method 3: Manual Browser Export

#### Chrome:

1. Open Chrome DevTools (F12)
2. Go to Application tab → Storage → Cookies → https://www.youtube.com
3. Copy relevant cookies to a text file in Netscape format

#### Firefox:

1. Type `about:preferences#privacy` in address bar
2. Click "Manage Data" under Cookies and Site Data
3. Search for "youtube.com"
4. Export the cookies

## Cookie File Format

The cookies file must be in **Netscape format**:

```
# Netscape HTTP Cookie File
# This file contains the session cookies generated by your browser
.youtube.com	TRUE	/	TRUE	1755331200	VISITOR_INFO1_LIVE	your_visitor_id_here
.youtube.com	TRUE	/	FALSE	1755331200	YSC	your_session_token_here
.youtube.com	TRUE	/	TRUE	1755331200	PREF	your_preferences_here
youtube.com	FALSE	/	FALSE	1640995200	GPS	1
```

**Important Notes:**

- Each line represents one cookie
- Fields are tab-separated: domain, subdomain_flag, path, secure, expiration, name, value
- Lines starting with `#` are comments
- Empty lines are ignored

## Security Considerations

⚠️ **Important Security Notes:**

1. **Never commit cookies to version control**

   - Add `*cookies*.txt` to your `.gitignore`
   - Keep cookies files private

2. **Cookies contain sensitive information**

   - They may include session tokens
   - Could potentially provide access to your account

3. **Rotate cookies regularly**

   - Cookies expire and need refresh
   - Update them when YouTube access stops working

4. **Use dedicated accounts**
   - Consider using a separate YouTube account for automation
   - Don't use your primary Google account

## Implementation Details

### Where Cookies Are Used

The cookie support has been implemented in the following components:

1. **Main Server (`server.js`)**

   - Video download operations
   - Video metadata extraction
   - Quality checking

2. **Robust Transcript Service V2 (`robustTranscriptServiceV2.js`)**

   - yt-dlp subtitle extraction strategies
   - Multiple client type fallbacks

3. **Anti-Detection Transcript Service (`antiDetectionTranscript.js`)**
   - Advanced bot evasion techniques
   - Session management with cookies

### Automatic Cookie Integration

The system automatically:

- Checks for cookies file existence
- Validates file format and size
- Adds `--cookies` flag to yt-dlp commands when available
- Falls back gracefully when cookies are unavailable
- Logs cookie usage for debugging

## Troubleshooting

### Comprehensive Troubleshooting Guide

#### Environment Variable Issues

**Problem: "Environment variable YTDLP_COOKIES_CONTENT too large"**

_Symptoms:_

- Azure deployment fails
- Environment variable not set properly
- Truncated cookies content

_Solutions:_

1. **Optimize cookies content:**

   ```bash
   # Remove unnecessary cookies, keep only YouTube-related ones
   # Keep lines containing: youtube.com, googlevideo.com, gstatic.com
   ```

2. **Use file-based approach:**

   ```bash
   # Set YTDLP_COOKIES_PATH instead
   YTDLP_COOKIES_PATH=/tmp/cookies.txt
   ```

3. **Encode cookies (advanced):**
   ```bash
   # Base64 encode for smaller size
   echo "your_cookies_content" | base64 > cookies_encoded.txt
   ```

#### Authentication & Bot Detection Issues

**Problem: "Sign in to confirm you're not a bot"**

_Symptoms:_

- Consistent yt-dlp failures
- YouTube blocking requests
- 403 Forbidden errors

_Root Causes & Solutions:_

1. **Expired Cookies:**

   ```bash
   # Test cookies validity
   cd backend
   npm run test-cookies-ytdlp

   # Re-export from browser if expired
   ```

2. **Invalid Cookie Format:**

   ```bash
   # Validate format
   npm run test-cookies-compare

   # Check for proper Netscape format with tabs
   ```

3. **Missing Essential Cookies:**

   ```bash
   # Ensure these cookies are present:
   # - VISITOR_INFO1_LIVE
   # - YSC
   # - PREF
   # - LOGIN_INFO (if logged in)
   ```

4. **IP/Location Mismatch:**
   ```bash
   # Cookies from different location than server
   # Solution: Use VPN or export cookies from similar location
   ```

#### Configuration Issues

**Problem: "No valid cookies file found"**

_Diagnosis Steps:_

```bash
# 1. Check environment variables
curl http://localhost:5001/api/debug/cookies-meta

# 2. Verify file existence (if using path-based)
ls -la /path/to/cookies.txt

# 3. Check permissions
ls -la $(dirname $YTDLP_COOKIES_PATH)

# 4. Test content validation
npm run test-cookies-compare
```

_Solutions:_

1. **Environment variable not set:**

   ```bash
   # Check if variable exists
   echo $YTDLP_COOKIES_CONTENT
   echo $YTDLP_COOKIES_PATH
   ```

2. **File path issues:**

   ```bash
   # Use absolute paths
   YTDLP_COOKIES_PATH=/full/path/to/cookies.txt
   ```

3. **Permission denied:**
   ```bash
   # Fix file permissions
   chmod 644 /path/to/cookies.txt
   chown $(whoami) /path/to/cookies.txt
   ```

#### Performance & Reliability Issues

**Problem: "Intermittent failures with cookies"**

_Monitoring & Diagnosis:_

```bash
# 1. Check startup validation
curl http://localhost:5001/api/debug/startup-validation

# 2. Monitor logs for patterns
tail -f /var/log/app.log | grep -i cookie

# 3. Test with known working video
npm run test-cookies-ytdlp
```

_Solutions:_

1. **Rate limiting:**

   ```bash
   # Add delays between requests
   # Implement exponential backoff
   ```

2. **Cookie rotation:**

   ```bash
   # Set up automated cookie refresh
   # Use multiple cookie sets
   ```

3. **Fallback strategies:**
   ```bash
   # Configure multiple extraction methods
   # Enable cookieless fallback
   ```

#### Azure/Production Specific Issues

**Problem: "Cookies work locally but fail in Azure"**

_Azure-Specific Checks:_

```bash
# 1. Environment variable size limits
# Azure: ~32KB limit per variable

# 2. File system constraints
# Azure: Read-only except /tmp

# 3. Network restrictions
# Azure: Different IP ranges
```

_Solutions:_

1. **Environment variable optimization:**

   ```bash
   # Compress cookies content
   # Remove non-essential cookies
   # Use file-based approach for large cookies
   ```

2. **Azure-specific configuration:**

   ```bash
   # Use /tmp for writable files
   YTDLP_COOKIES_PATH=/tmp/cookies.txt

   # Configure startup script to download cookies
   ```

3. **Network configuration:**
   ```bash
   # Add user-agent rotation
   # Configure proxy if needed
   # Use Azure-friendly IP ranges
   ```

### Diagnostic Commands

#### Quick Health Check

```bash
# Basic health check
curl http://localhost:5001/health

# Cookies-specific health check
curl http://localhost:5001/api/debug/cookies-meta
```

#### Comprehensive Validation

```bash
# Run all cookies tests
cd backend
npm run test-cookies

# Individual test components
npm run test-cookies-compare    # Environment vs file comparison
npm run test-cookies-ytdlp     # YouTube functionality test
npm run validate-cookies       # Startup validation only
```

#### Debug Information

```bash
# Environment debug (development only)
curl http://localhost:5001/api/debug/environment

# Startup validation results
curl http://localhost:5001/api/debug/startup-validation

# View detailed logs
tail -f logs/cookies-setup.log
```

### Common Error Patterns

| Error Message                    | Likely Cause            | Solution                          |
| -------------------------------- | ----------------------- | --------------------------------- |
| "Invalid cookie format"          | Wrong file format       | Ensure Netscape format with tabs  |
| "Cookies file too large"         | Size exceeds limits     | Optimize content or use file path |
| "Permission denied"              | File access issues      | Fix file permissions              |
| "Bot detection triggered"        | Expired/invalid cookies | Re-export from browser            |
| "Environment variable not found" | Missing configuration   | Set YTDLP_COOKIES_CONTENT         |
| "Connection timeout"             | Network issues          | Check proxy/firewall settings     |

### Best Practices for Troubleshooting

1. **Systematic Approach:**

   - Start with health checks
   - Verify configuration
   - Test individual components
   - Check logs for patterns

2. **Documentation:**

   - Keep track of working configurations
   - Document environment-specific settings
   - Maintain cookie refresh schedule

3. **Monitoring:**

   - Set up automated health checks
   - Monitor success/failure rates
   - Alert on consecutive failures

4. **Maintenance:**
   - Regular cookie refresh (monthly)
   - Update documentation when issues are resolved
   - Keep backup configurations

### Emergency Recovery

If cookies system completely fails:

1. **Immediate fallback:**

   ```bash
   # Disable cookies temporarily
   unset YTDLP_COOKIES_CONTENT
   unset YTDLP_COOKIES_PATH

   # Restart service
   systemctl restart your-app
   ```

2. **Quick cookie refresh:**

   ```bash
   # Export new cookies from browser
   # Update environment variable
   # Run validation tests
   npm run test-cookies
   ```

3. **Alternative approaches:**
   ```bash
   # Use different browser for export
   # Try incognito/private mode
   # Use VPN for different IP
   ```

---

## Common Issues

1. **"No valid cookies file found"**

   - Check the file path in `YTDLP_COOKIES_PATH`
   - Ensure the file exists and has content
   - Verify file permissions

2. **"Sign in to confirm you're not a bot" error persists**

   - Cookies may be expired - refresh them
   - Try logging into YouTube in browser first
   - Clear and re-export cookies

3. **yt-dlp still getting blocked**
   - YouTube may have updated detection methods
   - Try different browser for cookie export
   - Consider using VPN or different IP

### Debug Commands

Check if cookies are being detected:

```bash
# Check environment debug endpoint
curl http://localhost:5001/api/debug/environment

# Look for:
# - "cookies_path": "/path/to/cookies"
# - "cookies_exists": true
```

### Log Messages to Monitor

```
[COOKIES] ✅ Valid cookies file found: /path/to/cookies.txt (1234 bytes)
[SECURE-YTDLP] Adding cookies from: /path/to/cookies.txt
[ROBUST-V2] Using cookies from: /path/to/cookies.txt
```

## Production Deployment

### Azure/Vercel Deployment

1. **Upload cookies file to your deployment:**

   ```bash
   # Add to your project files
   mkdir -p backend/cookies
   cp youtube-cookies.txt backend/cookies/
   ```

2. **Set environment variable:**

   ```bash
   # Azure App Service
   # Set in Azure portal under Configuration > Application settings
   YTDLP_COOKIES_PATH=/home/site/wwwroot/cookies.txt

   # Vercel
   vercel env add YTDLP_COOKIES_PATH
   # Enter: /var/task/backend/cookies/youtube-cookies.txt
   ```

3. **Update .gitignore:**
   ```gitignore
   # Cookies (security)
   *cookies*.txt
   cookies/
   !backend/cookies/.gitkeep
   ```

### Docker Deployment

```dockerfile
# Copy cookies during build
COPY backend/cookies/youtube-cookies.txt /app/backend/cookies/
ENV YTDLP_COOKIES_PATH=/app/backend/cookies/youtube-cookies.txt
```

## Maintenance

1. **Monitor for failures:**

   - Watch for "bot detection" errors in logs
   - Set up alerts for repeated failures

2. **Refresh cookies monthly:**

   - YouTube sessions expire
   - Proactive refresh prevents downtime

3. **Test periodically:**
   - Use `/api/debug/environment` endpoint
   - Verify cookie file is detected

## Alternative Solutions

If cookies don't work:

1. **Use different IP ranges:**

   - VPN or proxy rotation
   - Different hosting providers

2. **Implement delays:**

   - Longer waits between requests
   - Random request timing

3. **Use alternative extractors:**
   - Different yt-dlp client types
   - Fallback to API-based methods

---

## Quick Setup Checklist

- [ ] Install browser extension for cookie export
- [ ] Visit YouTube and export cookies
- [ ] Save as `backend/cookies/youtube-cookies.txt`
- [ ] Set `YTDLP_COOKIES_PATH` environment variable (optional)
- [ ] Test with `/api/debug/environment` endpoint
- [ ] Monitor logs for cookie usage confirmation
- [ ] Add cookies to deployment pipeline
- [ ] Set up periodic cookie refresh

---

_Last updated: July 24, 2025_
